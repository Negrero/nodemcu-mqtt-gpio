# nodemcu-mqtt-gpio
example nodemcu with mqtt and gpio control

## Select module for firmware

* node
* mqtt
* cjson

## Install nodesjs npm mosca node-red

* Install nodejs and npm
* Install mosca: ```npm install mosca -g``` execute in terminal ```mosca -v```
* Install node-red: ```npm install node-red -g``` execute in terminal ```node-red -v```

## flow node-red

Copy and paste flow in import in node-red:

```[{"id":"772dc660.e5fbd8","type":"mqtt out","z":"4c3a8548.3bcf3c","name":"gpioxx","topic":"nodemcu/134494/gpioXX","qos":"","retain":"","broker":"eb9073fb.adce7","x":270,"y":200,"wires":[]},{"id":"1ae37acb.2f8775","type":"mqtt in","z":"4c3a8548.3bcf3c","name":"","topic":"nodemcu/134494/#","qos":"2","broker":"eb9073fb.adce7","x":130,"y":520,"wires":[[]]},{"id":"a3616ba.7591998","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 1 start","topic":"","payload":"{\"status\":\"start\", \"pin\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":80,"wires":[["772dc660.e5fbd8"]]},{"id":"16142118.57041f","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 1 stop","topic":"","payload":"{\"status\":\"stop\", \"pin\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":120,"wires":[["772dc660.e5fbd8"]]},{"id":"beedd31d.a793c","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 2 start","topic":"","payload":"{\"status\":\"start\", \"pin\":2}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":160,"wires":[["772dc660.e5fbd8"]]},{"id":"b68f30fe.ea8b2","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 2 stop","topic":"","payload":"{\"status\":\"stop\", \"pin\":2}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":200,"wires":[["772dc660.e5fbd8"]]},{"id":"7f911bee.2d92c4","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 3 stop","topic":"","payload":"{\"status\":\"stop\", \"pin\":3}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":280,"wires":[["772dc660.e5fbd8"]]},{"id":"7cc39bc0.20a144","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 3 start","topic":"","payload":"{\"status\":\"start\", \"pin\":3}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":240,"wires":[["772dc660.e5fbd8"]]},{"id":"c4e0e6aa.be3d48","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 4 stop","topic":"","payload":"{\"status\":\"stop\", \"pin\":4}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":360,"wires":[["772dc660.e5fbd8"]]},{"id":"179c0bad.4eba04","type":"inject","z":"4c3a8548.3bcf3c","name":"Pin 4 start","topic":"","payload":"{\"status\":\"start\", \"pin\":4}","payloadType":"json","repeat":"","crontab":"","once":false,"x":80,"y":320,"wires":[["772dc660.e5fbd8"]]},{"id":"ab8907ce.bc6de8","type":"function","z":"4c3a8548.3bcf3c","name":"Status gpio1 ","func":"\n    try{\n        var array=JSON.parse(msg.payload)    \n        if (array[0])\n            node.status({fill:\"green\",shape:\"dot\",text:\"connected\"});\n        else\n            node.status({fill:\"red\",shape:\"ring\",text:\"disconnected\"});        \n    }catch(ex){\n        node.status({fill:\"red\",shape:\"ring\",text:\"error json parse\"});        \n    }\n\n\nreturn msg","outputs":1,"noerr":0,"x":530,"y":100,"wires":[[]]},{"id":"73963040.2e2c1","type":"function","z":"4c3a8548.3bcf3c","name":"Status gpio 4","func":"\n    try{\n        var array=JSON.parse(msg.payload)    \n        if (array[3])\n        node.status({fill:\"green\",shape:\"dot\",text:\"connected\"});\n    else\n        node.status({fill:\"red\",shape:\"ring\",text:\"disconnected\"});        \n    }catch(ex){\n        node.status({fill:\"red\",shape:\"ring\",text:\"error json parse\"});        \n    }\n\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":300,"wires":[[]]},{"id":"ee3d4ed2.a90b","type":"function","z":"4c3a8548.3bcf3c","name":"Status gpio 2","func":"\n    try{\n        var array=JSON.parse(msg.payload)    \n        if (array[1])\n          node.status({fill:\"green\",shape:\"dot\",text:\"connected\"});\n         else\n         node.status({fill:\"red\",shape:\"ring\",text:\"disconnected\"});        \n    }catch(ex){\n        node.status({fill:\"red\",shape:\"ring\",text:\"error json parse\"});        \n    }\n \nreturn msg;","outputs":1,"noerr":0,"x":530,"y":180,"wires":[[]]},{"id":"47547ba0.159174","type":"function","z":"4c3a8548.3bcf3c","name":"Status gpio 3","func":"\n    try{\n        var array=JSON.parse(msg.payload)    \n        if (array[2])\n        node.status({fill:\"green\",shape:\"dot\",text:\"connected\"});\n    else\n        node.status({fill:\"red\",shape:\"ring\",text:\"disconnected\"});        \n    }catch(ex){\n        node.status({fill:\"red\",shape:\"ring\",text:\"error json parse\"});        \n    }\n    \n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":240,"wires":[[]]},{"id":"2fb74371.93455c","type":"inject","z":"4c3a8548.3bcf3c","name":"init","topic":"","payload":"{\"status\":\"init\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":90,"y":440,"wires":[["e83f606b.940f5"]]},{"id":"e83f606b.940f5","type":"mqtt out","z":"4c3a8548.3bcf3c","name":"status","topic":"nodemcu/134494/status","qos":"","retain":"","broker":"eb9073fb.adce7","x":280,"y":440,"wires":[]},{"id":"1cc0624c.cdef8e","type":"mqtt in","z":"4c3a8548.3bcf3c","name":"init","topic":"nodemcu/134494/init","qos":"2","broker":"eb9073fb.adce7","x":370,"y":200,"wires":[["ab8907ce.bc6de8","ee3d4ed2.a90b","47547ba0.159174","73963040.2e2c1"]]},{"id":"eb9073fb.adce7","type":"mqtt-broker","z":"","broker":"192.168.0.10","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""}]```
 
 node inject json with:{status:start or stop , pin: 1-4}
 
## mqtt apirest

* /nodemcu/gpioXX
